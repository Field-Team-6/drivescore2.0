<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Score ‚Äî Field Team 6</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Open+Sans:wght@400;500;600&family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue-dark: #1a2744;
            --blue-mid: #2b4c7e;
            --blue-bright: #3a7bd5;
            --blue-light: #5b9ef0;
            --blue-pale: #e8f0fe;
            --accent-gold: #f5c542;
            --white: #ffffff;
            --gray-50: #f8f9fa;
            --gray-100: #f0f2f5;
            --gray-200: #dde1e7;
            --gray-400: #9ca3af;
            --gray-600: #6b7280;
            --gray-800: #374151;
            --red-soft: #e74c3c;
            --green-success: #27ae60;
            --orange-warn: #e67e22;
            --shadow-sm: 0 1px 3px rgba(26, 39, 68, 0.12);
            --shadow-md: 0 4px 12px rgba(26, 39, 68, 0.15);
            --shadow-lg: 0 8px 30px rgba(26, 39, 68, 0.18);
            --radius: 10px;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Raleway', 'Open Sans', sans-serif;
            background: linear-gradient(135deg, var(--blue-dark) 0%, var(--blue-mid) 50%, #1e3a5f 100%);
            min-height: 100vh;
            color: var(--gray-800);
            line-height: 1.6;
        }

        /* ===== HEADER ===== */
        .header {
            background: rgba(26, 39, 68, 0.95);
            backdrop-filter: blur(10px);
            padding: 24px 24px 20px;
            text-align: center;
            border-bottom: 3px solid var(--accent-gold);
            z-index: 100;
        }
        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 10px;
        }
        .header-logo { height: 95px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .header h1 {
            font-family: 'Typewriter Serial ExtraBold', 'American Typewriter', 'Courier New Bold', 'Monaco Bold', 'Andale Mono', 'Lucida Console', monospace;
            font-weight: 900;
            font-size: clamp(2.4rem, 8vw, 6.72rem);
            color: #ffffff;
            letter-spacing: normal;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
            line-height: 0.85;
        }
        .header .tagline {
            color: var(--blue-light);
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.6;
        }
        .header .tagline-italic {
            color: var(--blue-light);
            font-size: 1rem;
            font-style: italic;
            font-weight: 500;
            margin-top: 2px;
        }

        /* ===== CONTAINER ===== */
        .container { max-width: 600px; margin: 0 auto; padding: 20px 16px 40px; }

        /* ===== CARDS ===== */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 28px 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .card-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.15rem;
            color: var(--blue-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-title .icon { font-size: 1.3rem; }

        /* ===== FORM FIELDS ===== */
        .field { margin-bottom: 16px; }
        .field label {
            display: block;
            font-weight: 600;
            font-size: 0.88rem;
            color: var(--gray-800);
            margin-bottom: 5px;
        }
        .field input, .field select, .field textarea {
            width: 100%;
            max-width: 100%;
            padding: 11px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Raleway', 'Open Sans', sans-serif;
            color: var(--gray-800);
            background: var(--gray-50);
            transition: border-color 0.2s, box-shadow 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }
        .field input:focus, .field select:focus, .field textarea:focus {
            outline: none;
            border-color: var(--blue-bright);
            box-shadow: 0 0 0 3px rgba(58, 123, 213, 0.15);
            background: var(--white);
        }
        .field-hint {
            font-size: 0.78rem;
            color: var(--gray-600);
            margin-top: 3px;
            font-style: italic;
        }
        .req { color: var(--red-soft); font-weight: 700; }

        /* ===== GRID ROWS ===== */
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }
        .row > *, .row-3 > *, .row-4 > * { min-width: 0; }

        /* ===== BUTTONS ===== */
        .btn {
            display: block;
            width: 100%;
            padding: 15px 24px;
            border: none;
            border-radius: var(--radius);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            transition: all 0.25s;
            letter-spacing: 0.3px;
        }
        .btn-continue {
            background: linear-gradient(135deg, var(--blue-bright), var(--blue-mid));
            color: var(--white);
            margin-top: 8px;
        }
        .btn-continue:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .btn-scan {
            background: linear-gradient(135deg, var(--accent-gold), #e6b530);
            color: var(--blue-dark);
            font-size: 1.1rem;
            padding: 18px 24px;
        }
        .btn-scan:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .btn-submit {
            background: linear-gradient(135deg, var(--green-success), #219a52);
            color: var(--white);
            margin-top: 8px;
        }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .btn-next {
            background: linear-gradient(135deg, var(--blue-bright), var(--blue-mid));
            color: var(--white);
            margin-top: 8px;
        }
        .btn-next:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .btn-done {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.4);
            color: rgba(255,255,255,0.9);
            margin-top: 10px;
            font-size: 0.95rem;
        }
        .btn-done:hover { border-color: rgba(255,255,255,0.7); background: rgba(255,255,255,0.05); }

        .btn-rescan {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 10px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 0.85rem;
            cursor: pointer;
            text-align: center;
        }
        .btn-rescan:hover { color: rgba(255,255,255,0.8); }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ===== DRIVE SUMMARY BAR ===== */
        .drive-summary {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: var(--radius);
            padding: 14px 18px;
            margin-bottom: 16px;
            color: rgba(255,255,255,0.85);
            font-size: 0.88rem;
            position: relative;
        }
        .summary-label {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-gold);
            margin-bottom: 4px;
        }
        .edit-link {
            position: absolute;
            top: 14px;
            right: 18px;
            font-size: 0.82rem;
            color: var(--accent-gold);
            cursor: pointer;
            text-decoration: none;
        }
        .edit-link:hover { text-decoration: underline; }

        /* ===== START SCAN AREA ===== */
        .scan-area {
            border: 3px dashed var(--gray-200);
            border-radius: var(--radius);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s, background 0.3s;
            cursor: pointer;
        }
        .scan-area:hover {
            border-color: var(--blue-bright);
            background: rgba(58, 123, 213, 0.03);
        }
        .scan-icon { font-size: 3rem; margin-bottom: 12px; }
        .scan-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        .scan-hint { font-size: 0.85rem; color: var(--gray-600); font-weight: 600; }
        .scan-privacy { font-size: 0.85rem; color: var(--gray-600); margin-top: 8px; font-style: italic; font-weight: 600; }

        /* ===== PROCESSING OVERLAY ===== */
        .processing-overlay {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        .processing-overlay.active { display: block; }
        .spinner {
            width: 48px; height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--blue-bright);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .processing-text {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--blue-bright);
            font-size: 1rem;
        }
        .processing-subtext {
            color: var(--gray-600);
            font-size: 0.85rem;
            margin-top: 4px;
        }

        /* ===== VOTER COUNTER ===== */
        .voter-counter {
            text-align: center;
            padding: 12px;
            background: rgba(245, 197, 66, 0.1);
            border: 1px solid rgba(245, 197, 66, 0.3);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }
        .voter-counter .count {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 2rem;
            color: var(--accent-gold);
        }
        .voter-counter .count-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }

        /* ===== CONFIDENCE INDICATOR ===== */
        .confidence-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .confidence-high {
            background: rgba(39, 174, 96, 0.1);
            color: var(--green-success);
            border: 1px solid rgba(39, 174, 96, 0.2);
        }
        .confidence-medium {
            background: rgba(230, 126, 34, 0.1);
            color: var(--orange-warn);
            border: 1px solid rgba(230, 126, 34, 0.2);
        }
        .confidence-low {
            background: rgba(231, 76, 60, 0.1);
            color: var(--red-soft);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        /* ===== STATUS ===== */
        .status {
            text-align: center; padding: 16px; border-radius: var(--radius);
            font-weight: 600; margin-top: 16px; display: none;
        }
        .status.success { display: block; background: rgba(39, 174, 96, 0.1); color: var(--green-success); border: 2px solid rgba(39, 174, 96, 0.3); }
        .status.error { display: block; background: rgba(231, 76, 60, 0.1); color: var(--red-soft); border: 2px solid rgba(231, 76, 60, 0.3); }
        .status.sending { display: block; background: rgba(58, 123, 213, 0.1); color: var(--blue-bright); border: 2px solid rgba(58, 123, 213, 0.3); }

        /* ===== HIDDEN ===== */
        .hidden { display: none !important; }

        /* ===== FAQ ===== */
        .faq-btn-wrapper { text-align: center; margin: 30px 0 20px; }
        .faq-toggle-btn {
            background: #03013c; color: white; padding: 12px 25px; border: none;
            border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold;
            font-family: 'Raleway', sans-serif; transition: all 0.3s ease;
        }
        .faq-toggle-btn:hover { background: #1a1a5e; transform: translateY(-2px); }
        .faq-container {
            display: none; background: white; border-radius: 15px;
            padding: 30px; margin: 20px auto; max-width: 720px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .faq-container.show { display: block; }
        .faq-header { text-align: center; margin-bottom: 30px; }
        .faq-header h2 { color: #333; font-size: 2rem; margin-bottom: 10px; font-family: 'Montserrat', sans-serif; }
        .faq-close {
            background: var(--blue-bright); color: white; border: none;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-family: 'Raleway', sans-serif; transition: all 0.3s ease;
        }
        .faq-close:hover { background: var(--blue-mid); transform: translateY(-2px); }
        .faq-item { margin-bottom: 25px; border-bottom: 1px solid #e1e5e9; padding-bottom: 20px; }
        .faq-item:last-child { border-bottom: none; }
        .faq-question { font-weight: bold; color: #333; font-size: 1.1rem; margin-bottom: 10px; }
        .faq-answer { color: #666; line-height: 1.6; font-size: 0.95rem; }
        .faq-answer a { color: var(--blue-bright); text-decoration: none; font-weight: 600; }
        .faq-answer a:hover { text-decoration: underline; }

        /* ===== FOOTER ===== */
        .footer { text-align: center; padding: 20px; color: rgba(255,255,255,0.5); font-size: 0.78rem; line-height: 1.7; }
        .footer a { color: rgba(255,255,255,0.7); text-decoration: none; }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 600px) {
            .card { padding: 20px 18px; }
            .row, .row-3 { grid-template-columns: 1fr; }
            .row-4 { grid-template-columns: 1fr 1fr; }
            .header-top { gap: 12px; }
            .header-logo { height: 72px; }
            .faq-container { margin: 10px; padding: 20px; }
            .faq-header h2 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header">
    <div class="header-top">
        <img src="https://drive-scout.netlify.app/images/FT6Logo2.png" alt="Field Team 6 Logo" class="header-logo">
        <h1>Drive Score</h1>
    </div>
    <div class="tagline">Report your results. Every voter counts!</div>
    <div class="tagline-italic">Because in this game, the high score is saving our democracy.</div>
</div>

<!-- ===== MAIN ===== -->
<div class="container">

    <!-- ========================================== -->
    <!-- STEP 1: DRIVE INFO                         -->
    <!-- ========================================== -->
    <div id="step1">
        <div class="card">
            <div class="card-title"><span class="icon">üìã</span> Drive Information</div>

            <div class="row">
                <div class="field">
                    <label for="leaderFirst">Drive Leader First Name <span class="req">*</span></label>
                    <input type="text" id="leaderFirst" placeholder="e.g. Jane" required>
                </div>
                <div class="field">
                    <label for="leaderLast">Drive Leader Last Name <span class="req">*</span></label>
                    <input type="text" id="leaderLast" placeholder="e.g. Smith" required>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label for="driveDate">Date of Drive <span class="req">*</span></label>
                    <input type="date" id="driveDate" required>
                </div>
                <div class="field">
                    <label for="driveTime">Time of Drive <span class="req">*</span></label>
                    <input type="time" id="driveTime" required>
                </div>
            </div>

            <div class="row">
                <div class="field">
                    <label for="driveCity">City <span class="req">*</span></label>
                    <input type="text" id="driveCity" placeholder="e.g. Phoenix" required>
                </div>
                <div class="field">
                    <label for="driveState">State <span class="req">*</span></label>
                    <select id="driveState" required>
                        <option value="">Select state‚Ä¶</option>
                        <option>Alabama</option><option>Alaska</option><option>Arizona</option><option>Arkansas</option>
                        <option>California</option><option>Colorado</option><option>Connecticut</option><option>Delaware</option>
                        <option>Florida</option><option>Georgia</option><option>Hawaii</option><option>Idaho</option>
                        <option>Illinois</option><option>Indiana</option><option>Iowa</option><option>Kansas</option>
                        <option>Kentucky</option><option>Louisiana</option><option>Maine</option><option>Maryland</option>
                        <option>Massachusetts</option><option>Michigan</option><option>Minnesota</option><option>Mississippi</option>
                        <option>Missouri</option><option>Montana</option><option>Nebraska</option><option>Nevada</option>
                        <option>New Hampshire</option><option>New Jersey</option><option>New Mexico</option><option>New York</option>
                        <option>North Carolina</option><option>North Dakota</option><option>Ohio</option><option>Oklahoma</option>
                        <option>Oregon</option><option>Pennsylvania</option><option>Rhode Island</option><option>South Carolina</option>
                        <option>South Dakota</option><option>Tennessee</option><option>Texas</option><option>Utah</option>
                        <option>Vermont</option><option>Virginia</option><option>Washington</option><option>West Virginia</option>
                        <option>Wisconsin</option><option>Wyoming</option><option>Washington D.C.</option>
                    </select>
                </div>
            </div>

            <button type="button" class="btn btn-continue" onclick="continueToScan()">
                Continue to Form Scanning ‚Üí
            </button>
            <div id="step1Error" class="status" style="display:none;"></div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- STEP 2: SCAN FORM                          -->
    <!-- ========================================== -->
    <div id="step2" class="hidden">

        <div class="drive-summary" id="driveSummary">
            <div class="summary-label">Drive Info</div>
            <div class="summary-details" id="summaryText"></div>
            <span class="edit-link" onclick="editDriveInfo()">‚úèÔ∏è Edit</span>
        </div>

        <div class="voter-counter" id="voterCounter">
            <div class="count" id="voterCountNum">0</div>
            <div class="count-label">voters submitted so far</div>
        </div>

        <div class="card">
            <div class="card-title"><span class="icon">üìã</span> Scan Voter Registration Form</div>

            <!-- Scan button triggers native camera -->
            <div id="scanArea" class="scan-area" onclick="document.getElementById('scanFile').click()">
                <div class="scan-icon"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAF0AAAA8CAIAAACLuyFrAAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAARqElEQVR42u1baYwlV3U+995by6u39uvu6e7ZemY8++bxeMMbNoZglgDBBBCJTRQHyA8rJJEhhBAhQEiIIEUKAaEQJYrIjxAlikCBKBFZBAGZyCLAkPEyMz0zvU13v3571av13nPyo3rGPfa4ZyUzdnz0fryq169f1XfP8n3n3AJ4mZhAFEIggEQEhFcNAADwPCQkyJ/3D8qXAyaIgKPDQ3/56d979L5DR6fmFnt9gcg/V/e88XGRQjDTh37l3e99//v2F/jX771dWYqBXxxMCKiEkEL8v8Alt4mRuukPBugMSdgxNsYMiPjiu9FEhugViAsiCiGFEC+4az8YSLDG9xyeWFfaPzF8wS8CikffcO/b774VEQHxFZNfEBCBVyw/zu+YmROdPfLWN6MUpZKScf+Zht/s9YUQDAiAUiIRP/Hoe778W78xroMfnJhrB4OryUE3EC4SkQE3jq/7049+8M4dk//19KnM6BwoIeT03JnDe3fdvHe7yeKC7kMa/2S6mWpCYEQkoqJj/8lHP5wlgx9+73s/mm0uBwO8ClxupDgSApg++TuPv//R9/3m3Yc+/JbXMbNAAQCADACf+tJXe0GoLK8+seHefRvv3D7BbASCQAaAsfpQUQg/CLKC56caAPgVkl+YAWDjcFUbGXqVtx+YvGvndkNkScWGpVRHnjv2pb/+23KlXKiPb9q88eE7d22fGDPEiAIAHKUoTYQlhWOhdbXM70aKIyGI+eCOLffdvA+ccrHuTZasYwvN+VbHQiRmkOKpI0cfvPv2jWOjWRpVPbG+Xnlmtt0JBgAwXCk/fO+dmpKlhTNHZhpL3T4KkWP9Ms+7KJh5qdl97N2/JBBVfWxDMd1eU9PLwXSzJwQKgXGS+mHy8Jvuz5gsR4wUZNG2fnxiLtFGWeqNdxygeLCwvHhsrj3T6uBVRJK8kcKIpRCLrVbP99/+0IN6kIJjFSnc6GFjkJ1utIFZSOu5qVO379u1e+vmlG3XtcoiMUYcOb2YanPP/m2OgLnl5vHZxelWcDWU+MbSAcwspfjhT48KxF947W2ZH7rFUkGE4xU3YTW10CLSgPizZ6fe9eBrLCRyKwqoaFKn5P30xNyDt+1TWdTo9QaJPrnc01rjKwOXHByprH9/8qmRSum+wwfDjF3FVZEcnByeGFt3fL4VRHGj0210/YfuudWwrNVrzfmTk+uqxaGRmqMwGfSiCBDn+1E/GCCKK6tLN6JuFExCqm9/98l1w7X777kjTmLp2K6rttasHZvGG/14odU9cvzUxOjoHTdtDE1SKtrLi0tbxmtoIOiF/ThJdZawnFlqI+IrBxcGAGAhxL/84KnDB/Yc2rczi9NCoSBtqwj6lpvGa8MjM2da//bUkdfetqciJUo0WRYE/tzScqfdT5K0FwSI8vRy3xj9Susz5PrmO9978tZ9+/ft3p7EA9t1Xa8a9jp7N1fvv2Xvc9MLQaJfs2NbNwiUayvLStN4au5M6EeDQSxtpxkmQRTjFQkleeOhgXlrDgCJaBAnX/vmP9drtVv37iAAr1T0Ctbcqeltk2O7NtZPz7Yn6h5kCStpWXbRtfwwbrT9KEwIIGTR7Pkve1zyHqWQwhDl0nHv1s0ffMvdDx3ecXrq5FClVLRx4PfAmMpQxfd9xUg6eObEqTQOgUBaDiMhZ8vtMIiTOEmL9aHZpQ7xlbQd1A3F6wwTGFOvVG/evf39b7n/bffeXIbIRH6SJovdVuPUGU3SEIAUGUFkeHLTBs/zp0+fWWj5ExODaqVo295QzWv2gv4g8jgbHaoutlqIyJdJfPFinzLieX+Gq7IjIiCs7nSc+3XOvffFF4MvcZRr38kNYx9//LGH7nrN+vWjEtBvt5M4VEgmS5AGJh5E4SBMktAfpFF8eubMj07OV2sl13Gby504oYnRkUrFbXZ6x2cbjaVmyroFpSPHT14BLvIiKyjkC/4jn33lt80Xtpc6/5JGTMz0yLve9onPf7RkMO52B425bNDBsAdSu+U6Sg/tku1VLEtJlF6pCJTNzjWOHJ8J43ikXiWEdrcbhLFQKstiw+QPEq9UWWj1DRFewzgSiETGtmyv4AKzbdtSCkQEQCEQEAuuO7l5EwIhIgIQUZpmQRAw8Lp1o4WCs7i4zJz3l1gKCQgC8KwJAFBKArKUQklpGEuu1f3x99OFmf5iM+zG3d5gbmauvmXDnn0HJBrX89gpg1C25UTRwHPtnZtGY6Kp+QYDbpoYBeBeP+wNIk3acqxyqRTreF29Mtdo5h2vaxBHKJCJf/U9v/z4hx6zJCJCr+9HSSJQEBlgJmOEEK7raG2yLCMmItY6S5IEGJUlASBNEiYmMoaIAcgYItJaGyKt9bnDLMuYmJGTOIsHbSICAjIQJulItXbzwV2OSR3tDxet+vBo2VM6zqStep1Wp7E82+gcnVn+nxOn169ft3F8OI6TONKtfuCHkWXZfhg1YvHUM1Org/zK/QURmXhkuP6Jj31k05ZNiR9WquXHn/jYP3zzW7ZSWmtmJjJkTJZpQ6SNMcbw+YnpmuTiO2+95f7XPzDw/dCUNcLsyXa3MfOOt75Juk5FgBAgXVcV3ETrqdnFSqk0NloxXlaueIMkW1puFZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAARqElEQVR42u1baYwlV3U+995by6u39uvu6e7ZemY8++bxeMMbNoZglgDBBBCJTRQHyA8rJJEhhBAhQEiIIEUKAaEQJYrIjxAlikCBKBFZBAGZyCLAkPEyMz0zvU13v7571av13nPyo3rGPfa4ZyUzdnz0fryq169f1XfP8n3n3AJ4mZhAFEIggEQEhFcNAADwPCQkyJ/3D8qXAyaIgKPDQ3/56d979L5DR6fmFnt9gcg/V/e88XGRQjDTh37l3e99//v2F/jX771dWYqBXxxMCKiEkEL8v8Alt4mRuukPBugMSdgxNsYMiPjiu9FEhugViAsiCiGFEC+4az8YSLDG9xyeWFfaPzF8wS8CikffcO/b774VEQHxFZNfEBCBVyw/zu+YmROdPfLWN6MUpZKScf+Zht/s9YUQDAiAUiIRP/Hoe778W78xroMfnJhrB4OryUE3EC4SkQE3jq/7049+8M4dk//19KnM6BwoIeT03JnDe3fdvHe7yeKC7kMa/2S6mWpCYEQkoqJj/8lHP5wlgx9+73s/mm0uBwO8ClxupDgSApg++TuPv//R9/3m3Yc+/JbXMbNAAQCADACf+tJXe0GoLK8+seHefRvv3D7BbASCQAaAsfpQUQg/CLKC56caAPgVkl+YAWDjcFUbGXqVtx+YvGvndkNkScWGpVRHnjv2pb/+23KlXKiPb9q88eE7d22fGDPEiAIAHKUoTYQlhWOhdbXM70aKIyGI+eCOLffdvA+ccrHuTZasYwvN+VbHQiRmkOKpI0cfvPv2jWOjWRpVPbG+Xnlmtt0JBgAwXCk/fO+dmpKlhTNHZhpL3T4KkWP9Ms+7KJh5qdl97N2/JBBVfWxDMd1eU9PLwXSzJwQKgXGS+mHy8Jvuz5gsR4wUZNG2fnxiLtFGWeqNdxygeLCwvHhsrj3T6uBVRJK8kcKIpRCLrVbP99/+0IN6kIJjFSnc6GFjkJ1utIFZSOu5qVO379u1e+vmlG3XtcoiMUYcOb2YanPP/m2OgLnl5vHZxelWcDWU+MbSAcwspfjhT48KxF947W2ZH7rFUkGE4xU3YTW10CLSgPizZ6fe9eBrLCRyKwqoaFKn5P30xNyDt+1TWdTo9QaJPrnc01rjKwOXHByprH9/8qmRSum+wwfDjF3FVZEcnByeGFt3fL4VRHGj0210/YfuudWwrNVrzfmTk+uqxaGRmqMwGfSiCBDn+1E/GCCKK6tLN6JuFExCqm9/98l1w7X777kjTmLp2K6rttasHZvGG/14odU9cvzUxOjoHTdtDE1SKtrLi0tbxmtoIOiF/ThJdZawnFlqI+IrBxcGAGAhxL/84KnDB/Yc2rczi9NCoSBtqwj6lpvGa8MjM2da//bUkdfetqciJUo0WRYE/tzScqfdT5K0FwSI8vRy3xj9Susz5PrmO9978tZ9+/ft3p7EA9t1Xa8a9jp7N1fvv2Xvc9MLQaJfs2NbNwiUayvLStN4au5M6EeDQSxtpxkmQRTjFQkleeOhgXlrDgCJaBAnX/vmP9drtVv37iAAr1T0Ctbcqeltk2O7NtZPz7Yn6h5kCStpWXbRtfwwbrT9KEwIIGTR7Pkve1zyHqWQwhDl0nHv1s0ffMvdDx3ecXrq5FClVLRx4PfAmMpQxfd9xUg6eObEqTQOgUBaDiMhZ8vtMIiTOEmL9aHZpQ7xlbQd1A3F6wwTGFOvVG/evf39b7n/bffeXIbIRH6SJovdVuPUGU3SEIAUGUFkeHLTBs/zp0+fWWj5ExODaqVo295QzWv2gv4g8jgbHaoutlqIyJdJfPFinzLieX+Gq7IjIiCs7nSc+3XOvffFF4MvcZRr38kNYx9//LGH7nrN+vWjEtBvt5M4VEgmS5AGJh5E4SBMktAfpFF8eubMj07OV2sl13Gby504oYnRkUrFbXZ6x2cbjaVmyroFpSPHT14BLvIiKyjkC/4jn33lt80Xtpc6/5JGTMz0yLve9onPf7RkMO52B425bNDBsAdSu+U6Sg/tku1VLEtJlF6pCJTNzjWOHJ8J43ikXiWEdrcbhLFQKstiw+QPEq9UWWj1DRFewzgSiETGtmyv4AKzbdtSCkQEQCEQEAuuO7l5EwIhIgIQUZpmQRAw8Lp1o4WCs7i4zJz3l1gKCQgC8KwJAFBKArKUQklpGEuu1f3x99OFmf5iM+zG3d5gbmauvmXDnn0HJBrX89gpg1C25UTRwHPtnZtGY6Kp+QYDbpoYBeBeP+wNIk3acqxyqRTreF29Mtdo5h2vaxBHKJCJf/U9v/z4hx6zJCJCr+9HSSJQEBlgJmOEEK7raG2yLCMmItY6S5IEGJUlASBNEiYmMoaIAcgYItJaGyKt9bnDLMuYmJGTOIsHbSICAjIQJulItXbzwV2OSR3tDxet+vBo2VM6zqStep1Wp7E82+gcnVn+nxOn169ft3F8OI6TONKtfuCHkWXZfhg1YvHUM9Org/zK/QURmXhkuP6Jj31k05ZNiR9WquXHn/jYP3zzW7ZSWmtmJjJkTJZpQ6SNMcbw+YnpmuTiO2+95f7XPzDw/dCUNcLsyXa3MfOOt75Juk5FgBAgXVcV3ETrqdnFSqk0NloxXlaueIMkW1puFZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQ==" alt="phone" style="height: 56px; width: auto;"></div>
                <div class="scan-text">Tap to scan form</div>
                <div id="scanHint" class="scan-hint"><span style="color: var(--red-soft); font-weight: 800;">IMPORTANT:</span> Turn the phone horizontal (landscape) and get as close to the form as you can, while keeping name, address and date of birth visible.</div>
                <div class="scan-privacy">The scan is only used to capture the text. The image is never saved or stored.</div>
            </div>

            <!-- Hidden file input with native camera capture -->
            <input type="file" id="scanFile" accept="image/*" capture="environment" onchange="handleScanCapture(event)" style="display:none;">


            <!-- Processing overlay -->
            <div class="processing-overlay" id="processingOverlay">
                <div class="spinner"></div>
                <div class="processing-text">Reading the form‚Ä¶</div>
                <div class="processing-subtext">This usually takes a few seconds</div>
            </div>

            <div id="scanError" class="status" style="display:none;"></div>
        </div>

        <button type="button" class="btn btn-done" onclick="finishDrive()">
            ‚úÖ Done ‚Äî Finish Drive Report
        </button>
    </div>

    <!-- ========================================== -->
    <!-- STEP 3: REVIEW & EDIT                      -->
    <!-- ========================================== -->
    <div id="step3" class="hidden">

        <div class="drive-summary">
            <div class="summary-label">Drive Info</div>
            <div class="summary-details" id="summaryText2"></div>
        </div>

        <div class="card">
            <div class="card-title"><span class="icon">‚úèÔ∏è</span> Review Voter #<span id="reviewVoterNum">1</span></div>

            <div id="confidenceIndicator" class="confidence-bar confidence-high">
                <span id="confidenceIcon">‚úÖ</span>
                <span id="confidenceText">High confidence ‚Äî please double-check the fields below</span>
            </div>

            <div class="row-4">
                <div class="field">
                    <label for="vFirstName">First Name <span class="req">*</span></label>
                    <input type="text" id="vFirstName" placeholder="First" required>
                </div>
                <div class="field">
                    <label for="vMiddleName">Middle Name</label>
                    <input type="text" id="vMiddleName" placeholder="Middle">
                </div>
                <div class="field">
                    <label for="vLastName">Last Name <span class="req">*</span></label>
                    <input type="text" id="vLastName" placeholder="Last" required>
                </div>
                <div class="field">
                    <label for="vSuffix">Suffix</label>
                    <input type="text" id="vSuffix" placeholder="Jr., II">
                </div>
            </div>

            <div class="field">
                <label for="vStreet">Street Address <span class="req">*</span></label>
                <input type="text" id="vStreet" placeholder="e.g. 123 Main Street" required>
            </div>

            <div class="field">
                <label for="vApt">Apt #/Unit #</label>
                <input type="text" id="vApt" placeholder="e.g. Apt 4B">
            </div>

            <div class="row-3">
                <div class="field">
                    <label for="vCity">City <span class="req">*</span></label>
                    <input type="text" id="vCity" required>
                </div>
                <div class="field">
                    <label for="vState">State <span class="req">*</span></label>
                    <input type="text" id="vState" readonly tabindex="-1" autocomplete="off">
                </div>
                <div class="field">
                    <label for="vZip">ZIP Code <span class="req">*</span></label>
                    <input type="text" id="vZip" placeholder="e.g. 85001" required>
                </div>
            </div>

            <!-- DOB field ‚Äî dynamically shown/hidden based on state -->
            <div id="dobField">
                <label>Date of Birth <span class="req">*</span></label>
                <div class="row-3">
                    <div class="field">
                        <select id="vDOBMonth">
                            <option value="">Month</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="field">
                        <select id="vDOBDay">
                            <option value="">Day</option>
                        </select>
                    </div>
                    <div class="field">
                        <select id="vDOBYear">
                            <option value="">Year</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Georgia / Colorado: Year of Birth only -->
            <div id="yobField" class="field hidden">
                <label for="vYOB">Year of Birth <span class="req">*</span></label>
                <input type="text" id="vYOB" placeholder="e.g. 2004">
                <div class="field-hint">Georgia and Colorado require year of birth only</div>
            </div>
        </div>

        <div id="reviewError" class="status" style="display:none;"></div>

        <button type="button" class="btn btn-submit" id="submitVoterBtn" onclick="submitVoterAndNext()">
            ‚úÖ Submit & Scan Next Form
        </button>

        <button type="button" class="btn btn-done" onclick="submitVoterAndFinish()" style="margin-top:8px;">
            ‚úÖ Submit & Finish (Last Form)
        </button>

        <button type="button" class="btn-rescan" onclick="rescanForm()">
            üîÑ Scan this form again
        </button>
    </div>

    <!-- ========================================== -->
    <!-- STEP 4: COMPLETE                           -->
    <!-- ========================================== -->
    <div id="step4" class="hidden">
        <div class="card" style="text-align:center; padding: 40px 24px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">üéâ</div>
            <div class="card-title" style="justify-content: center; font-size: 1.3rem; margin-bottom: 12px;">Drive Report Complete!</div>
            <p style="color: var(--gray-600); margin-bottom: 8px;">
                You submitted <strong id="finalCount">0</strong> voter<span id="finalPlural">s</span> from this drive.
            </p>
            <p style="color: var(--gray-600); font-size: 0.9rem; margin-bottom: 24px;">
                That is <strong id="finalCount2">0</strong> more vote<span id="finalPlural2">s</span> for sanity, humanity, and democracy. Thank you for this great work ‚Äì keep going! üó≥Ô∏è
            </p>
            <button type="button" class="btn btn-continue" onclick="startNewDrive()">
                üîÑ Restart Drive Score
            </button>
        </div>
    </div>

</div>

<!-- ===== FAQ ===== -->
<div class="faq-btn-wrapper">
    <button class="faq-toggle-btn" onclick="toggleFAQ()">FAQ</button>
</div>

<div class="faq-container" id="faqContainer">
    <div class="faq-header">
        <h2>üéØ Drive Score FAQ</h2>
        <button class="faq-close" onclick="toggleFAQ()">Close FAQ</button>
    </div>

    <div class="faq-item">
        <div class="faq-question">Who built Drive Score?</div>
        <div class="faq-answer">
            Drive Score is a project of <a href="https://www.fieldteam6.org" target="_blank">Field Team 6</a>, a proudly partisan voter registration organization. Our legal designation is a 527 federal PAC working on the IE side.
        </div>
    </div>

    <div class="faq-item">
        <div class="faq-question">Why do you need this info?</div>
        <div class="faq-answer">
            We need this basic info 1) to calculate how many voters Field Team 6 is registering, and 2) so we can find out how many of these new voters <em>actually voted</em> after the next election! You and our thousands of volunteers are doing so much good, but if we can't measure that good so we can tell the world, we can't get more volunteers and donors.<br><br>
            <em>Reporting your Drive Score is literally what keeps Field Team 6 alive and thriving!</em>
        </div>
    </div>

    <div class="faq-item">
        <div class="faq-question">I turned my phone sideways, but something's not working ‚Äì and Drive Score has trouble reading it. Help!</div>
        <div class="faq-answer">
            1. Rotate your phone sideways so that you're shooting in landscape, not portrait mode. (Taking a horizontal shot.) <em>You may have to wait a second for the phone to re-orient.</em><br>
            2. Hold the phone as close to the form as you can while keeping the full name, full address, and date of birth in the frame.<br>
            3. Click the button!
        </div>
    </div>

    <div class="faq-item">
        <div class="faq-question">Are there any privacy risks?</div>
        <div class="faq-answer">
            Drive Score was designed specifically to eliminate privacy risks. That's why the scan is used only to read the text, and is never saved or stored.
        </div>
    </div>

    <div class="faq-item">
        <div class="faq-question">Are my Drive Score results shared with the Democratic Party, any campaign, any list, or any group besides Field Team 6?</div>
        <div class="faq-answer">
            Absolutely not.
        </div>
    </div>

    <div class="faq-item">
        <div class="faq-question">How many voters do I have to register to make a difference?</div>
        <div class="faq-answer">
            Every single voter counts! Major elections have been decided by a single vote. And if you amplify that one voter times a thousand voter drives across the country, that's now 1,000 new voters. Also remember, each voter can vote up and down the ballot, affecting hundreds of races over the course of their lives! <em>You are making a giant difference ‚Äì keep going!!</em>
        </div>
    </div>

    <p style="text-align:center; margin-top: 20px;">
        <strong>Any questions or feedback? Contact us at: <a href="mailto:info@FieldTeam6.org" style="color: var(--blue-bright); text-decoration: none;">info@FieldTeam6.org</a></strong>
    </p>
    <p style="text-align:center; margin-top: 10px;">
        <em style="color: var(--blue-bright); font-weight: 600;">Thank you for registering Democrats, and saving the world!</em>
    </p>
</div>

<!-- ===== FOOTER ===== -->
<div class="footer">
    ¬©2026 Drive Score<br>
    Paid for by Field Team 6. <a href="https://www.fieldteam6.org" target="_blank">www.fieldteam6.org</a>.<br>
    Not authorized by any candidate or candidate's committee.
</div>

<!-- ===== JAVASCRIPT ===== -->
<script>
    // ============================================================
    // üîß CONFIGURATION
    // Paste your Google Apps Script URL below.
    // This SINGLE endpoint handles both OCR extraction and
    // data submission ‚Äî the "action" field tells it what to do.
    // ============================================================
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQOTtO__-vM11NtUgJrcqKbmDbZBmuzbs-TcN5HeSxELDaLhs27D9EyBdgknUTfIft/exec";
    const EXTRACT_URL = "/.netlify/functions/extract";
    // ============================================================

    // ---- State ----
    let selectedState = "";
    let voterCount = 0;

    // ---- Set today's date as default ----
    document.addEventListener("DOMContentLoaded", () => {
        const today = new Date();
        document.getElementById("driveDate").value = today.toISOString().split("T")[0];
        const hh = String(today.getHours()).padStart(2, "0");
        const mm = String(today.getMinutes()).padStart(2, "0");
        document.getElementById("driveTime").value = `${hh}:${mm}`;

        // Populate DOB Day dropdown (1-31)
        const daySelect = document.getElementById("vDOBDay");
        for (let d = 1; d <= 31; d++) {
            const opt = document.createElement("option");
            opt.value = String(d).padStart(2, "0");
            opt.textContent = d;
            daySelect.appendChild(opt);
        }

        // Populate DOB Year dropdown (1920 to current year)
        const yearSelect = document.getElementById("vDOBYear");
        const currentYear = today.getFullYear();
        for (let y = currentYear; y >= 1920; y--) {
            const opt = document.createElement("option");
            opt.value = String(y);
            opt.textContent = y;
            yearSelect.appendChild(opt);
        }
    });

    // Handle scan capture ‚Äî skip preview, go straight to extraction
    async function handleScanCapture(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Hide scan area, show processing immediately
        document.getElementById("scanArea").style.display = "none";
        document.getElementById("processingOverlay").classList.add("active");
        document.querySelector(".processing-subtext").textContent = "This usually takes a few seconds";
        hideError("scanError");

        try {
            // Read EXIF orientation (phones record gyroscope data here)
            const orientation = await getExifOrientation(file);

            // Load image ‚Äî try to get raw pixels without browser EXIF auto-rotation
            const { img, needsManualRotation } = await loadImageForProcessing(file);
            const applyOrientation = needsManualRotation ? orientation : 1;

            // Compress to fit within 5MB base64 API limit
            const MAX_BASE64_CHARS = 5 * 1024 * 1024;
            let base64 = "";
            let passes = 0;

            base64 = resizeAndCompress(img, 1200, 0.90, applyOrientation);

            if (base64.length > MAX_BASE64_CHARS) {
                const steps = [[1200, 0.80], [1000, 0.85], [1000, 0.80]];
                for (const [w, q] of steps) {
                    base64 = resizeAndCompress(img, w, q, applyOrientation);
                    passes++;
                    if (base64.length <= MAX_BASE64_CHARS) break;
                }
            }

            const sizeMB = (base64.length / 1024 / 1024).toFixed(1);
            document.querySelector(".processing-subtext").textContent = `${sizeMB}MB`;

            // Send to Netlify function (direct to Claude API ‚Äî no Apps Script middleman)
            const response = await fetch(EXTRACT_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    image: base64,
                    state: selectedState
                })
            });

            const text = await response.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch (parseErr) {
                throw new Error("Unexpected response from server. Please try again.");
            }

            if (result.error) {
                throw new Error(result.error);
            }

            populateReviewForm(result);

            document.getElementById("step2").classList.add("hidden");
            document.getElementById("step3").classList.remove("hidden");
            document.getElementById("reviewVoterNum").textContent = voterCount + 1;
            window.scrollTo({ top: 0, behavior: "smooth" });

        } catch (err) {
            showError("scanError", "Scan failed: " + err.message + " ‚Äî You can try again or enter data manually.");
            document.getElementById("scanArea").style.display = "block";
        } finally {
            document.getElementById("processingOverlay").classList.remove("active");
            document.getElementById("scanFile").value = "";
        }
    }

    // ================================================================
    // IMAGE PROCESSING ‚Äî EXIF orientation + resize/compress
    // ================================================================

    // Read EXIF orientation tag from JPEG file (returns 1-8, default 1)
    // Phones record gyroscope orientation here regardless of UI rotation state
    function getExifOrientation(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const view = new DataView(e.target.result);
                    if (view.getUint16(0, false) !== 0xFFD8) { resolve(1); return; }
                    let offset = 2;
                    while (offset < view.byteLength - 2) {
                        const marker = view.getUint16(offset, false);
                        offset += 2;
                        if (marker === 0xFFE1) {
                            if (view.getUint32(offset + 2, false) !== 0x45786966) { resolve(1); return; }
                            const tiffStart = offset + 8;
                            const bigEndian = view.getUint16(tiffStart, false) === 0x4D4D;
                            const ifdOffset = view.getUint32(tiffStart + 4, bigEndian);
                            const entries = view.getUint16(tiffStart + ifdOffset, bigEndian);
                            for (let i = 0; i < entries; i++) {
                                const entryOffset = tiffStart + ifdOffset + 2 + i * 12;
                                if (view.getUint16(entryOffset, bigEndian) === 0x0112) {
                                    resolve(view.getUint16(entryOffset + 8, bigEndian));
                                    return;
                                }
                            }
                            resolve(1); return;
                        } else if ((marker & 0xFF00) === 0xFF00) {
                            offset += view.getUint16(offset, false);
                        } else { break; }
                    }
                } catch(e) {}
                resolve(1);
            };
            // Only read first 64KB ‚Äî EXIF is always near the start
            reader.readAsArrayBuffer(file.slice(0, 65536));
        });
    }

    // Load image, trying to get raw pixels WITHOUT browser EXIF auto-rotation
    async function loadImageForProcessing(file) {
        // Try createImageBitmap with imageOrientation:'none' (Chrome 93+, Firefox 98+)
        // This gives raw sensor pixels so we can apply EXIF rotation ourselves
        if (typeof createImageBitmap !== "undefined") {
            try {
                const bitmap = await createImageBitmap(file, { imageOrientation: "none" });
                return { img: bitmap, needsManualRotation: true };
            } catch(e) { /* option not supported (Safari), fall through */ }
        }
        // Fallback: regular Image loading ‚Äî modern browsers auto-apply EXIF
        return { img: await loadImageFromFile(file), needsManualRotation: false };
    }

    // Load image via object URL (browser applies EXIF automatically)
    function loadImageFromFile(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            const url = URL.createObjectURL(file);
            img.onload = function() { URL.revokeObjectURL(url); resolve(img); };
            img.onerror = function() { URL.revokeObjectURL(url); reject(new Error("Could not read the scanned image.")); };
            img.src = url;
        });
    }

    // Resize, apply EXIF rotation, and return base64 JPEG
    // orientation: 1=normal, 3=180¬∞, 6=90¬∞CW, 8=90¬∞CCW (others rare)
    function resizeAndCompress(img, maxDim, quality, orientation) {
        const srcW = img.width;
        const srcH = img.height;

        // For 90¬∞/270¬∞ rotations, output dimensions are swapped
        const swap = orientation >= 5 && orientation <= 8;
        let outW = swap ? srcH : srcW;
        let outH = swap ? srcW : srcH;

        // Scale so longest edge fits within maxDim
        const longest = Math.max(outW, outH);
        if (longest > maxDim) {
            const scale = maxDim / longest;
            outW = Math.round(outW * scale);
            outH = Math.round(outH * scale);
        }

        const canvas = document.createElement("canvas");
        canvas.width = outW;
        canvas.height = outH;
        const ctx = canvas.getContext("2d");

        // Apply EXIF orientation transform, then draw scaled image
        switch (orientation) {
            case 2: // Flip horizontal
                ctx.translate(outW, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(img, 0, 0, outW, outH);
                break;
            case 3: // Rotate 180¬∞
                ctx.translate(outW, outH);
                ctx.rotate(Math.PI);
                ctx.drawImage(img, 0, 0, outW, outH);
                break;
            case 4: // Flip vertical
                ctx.translate(0, outH);
                ctx.scale(1, -1);
                ctx.drawImage(img, 0, 0, outW, outH);
                break;
            case 5: // Rotate 90¬∞CW + flip horizontal
                ctx.translate(outW, 0);
                ctx.rotate(Math.PI / 2);
                ctx.scale(-1, 1);
                ctx.drawImage(img, 0, 0, outH, outW);
                break;
            case 6: // Rotate 90¬∞CW
                ctx.translate(outW, 0);
                ctx.rotate(Math.PI / 2);
                ctx.drawImage(img, 0, 0, outH, outW);
                break;
            case 7: // Rotate 90¬∞CCW + flip horizontal
                ctx.translate(0, outH);
                ctx.rotate(-Math.PI / 2);
                ctx.scale(-1, 1);
                ctx.drawImage(img, 0, 0, outH, outW);
                break;
            case 8: // Rotate 90¬∞CCW
                ctx.translate(0, outH);
                ctx.rotate(-Math.PI / 2);
                ctx.drawImage(img, 0, 0, outH, outW);
                break;
            default: // 1 = normal, no rotation
                ctx.drawImage(img, 0, 0, outW, outH);
        }

        return canvas.toDataURL("image/jpeg", quality).split(",")[1];
    }

    // ================================================================
    // STEP 1 ‚Üí STEP 2:  Drive Info ‚Üí Scan
    // ================================================================
    function continueToScan() {
        const first = document.getElementById("leaderFirst").value.trim();
        const last = document.getElementById("leaderLast").value.trim();
        const date = document.getElementById("driveDate").value;
        const time = document.getElementById("driveTime").value;
        const city = document.getElementById("driveCity").value.trim();
        const state = document.getElementById("driveState").value;

        if (!first || !last || !date || !time || !city || !state) {
            showError("step1Error", "Please fill in all drive info fields.");
            return;
        }
        hideError("step1Error");
        selectedState = state;

        // Populate summary
        const summary = `${first} ${last} ¬∑ ${formatDate(date)} at ${formatTime(time)} ¬∑ ${city}, ${state}`;
        document.getElementById("summaryText").textContent = summary;
        document.getElementById("summaryText2").textContent = summary;

        // Configure DOB fields for review step based on state
        configureDOBFields();

        // Set scan guidance based on state
        const importantPrefix = '<span style="color: var(--red-soft); font-weight: 800;">IMPORTANT:</span> ';
        let scanTip = importantPrefix + "Turn the phone horizontal (landscape) and get as close to the form as you can, while keeping name, address and date of birth visible.";
        if (state === "Georgia" || state === "Colorado") {
            scanTip = importantPrefix + "Turn the phone horizontal (landscape) and get as close to the form as you can, while keeping name, address and year of birth visible.";
        } else if (state === "North Carolina") {
            scanTip = importantPrefix + "Turn the phone horizontal (landscape) and get as close to the form as you can, while keeping name and address visible.";
        }
        document.getElementById("scanHint").innerHTML = scanTip;

        // Show scan step
        document.getElementById("step1").classList.add("hidden");
        document.getElementById("step2").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function editDriveInfo() {
        resetScanStep();
        document.getElementById("step2").classList.add("hidden");
        document.getElementById("step1").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function configureDOBFields() {
        const dobField = document.getElementById("dobField");
        const yobField = document.getElementById("yobField");

        if (selectedState === "Georgia" || selectedState === "Colorado") {
            dobField.classList.add("hidden");
            yobField.classList.remove("hidden");
        } else if (selectedState === "North Carolina") {
            dobField.classList.add("hidden");
            yobField.classList.add("hidden");
        } else {
            dobField.classList.remove("hidden");
            yobField.classList.add("hidden");
        }
    }

    // ================================================================
    // STEP 3:  Review form population
    // ================================================================

    function populateReviewForm(data) {
        document.getElementById("vFirstName").value = data.firstName || "";
        document.getElementById("vMiddleName").value = data.middleName || "";
        document.getElementById("vLastName").value = data.lastName || "";
        document.getElementById("vSuffix").value = data.suffix || "";
        document.getElementById("vStreet").value = data.street || "";
        document.getElementById("vApt").value = data.apt || "";
        document.getElementById("vCity").value = data.city || "";
        document.getElementById("vState").value = selectedState;
        document.getElementById("vZip").value = data.zip || "";

        // Handle DOB based on state
        if (selectedState === "Georgia" || selectedState === "Colorado") {
            document.getElementById("vYOB").value = data.yearOfBirth || "";
        } else if (selectedState !== "North Carolina") {
            // Standard DOB ‚Äî parse and set the 3 dropdowns
            if (data.dob) {
                const parsed = parseDOB(data.dob);
                if (parsed) {
                    const [year, month, day] = parsed.split("-");
                    document.getElementById("vDOBMonth").value = month;
                    document.getElementById("vDOBDay").value = day;
                    document.getElementById("vDOBYear").value = year;
                }
            }
        }

        // Show confidence indicator
        updateConfidence(data.confidence || "medium");
    }

    function parseDOB(dobString) {
        // Attempt to parse various DOB formats into YYYY-MM-DD
        if (!dobString) return "";

        // Already in YYYY-MM-DD format
        if (/^\d{4}-\d{2}-\d{2}$/.test(dobString)) return dobString;

        // MM/DD/YYYY or MM-DD-YYYY
        const match = dobString.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
        if (match) {
            const mm = match[1].padStart(2, "0");
            const dd = match[2].padStart(2, "0");
            return `${match[3]}-${mm}-${dd}`;
        }

        // Try built-in Date parsing as fallback
        const d = new Date(dobString);
        if (!isNaN(d.getTime())) {
            return d.toISOString().split("T")[0];
        }

        return "";
    }

    function updateConfidence(level) {
        const bar = document.getElementById("confidenceIndicator");
        const icon = document.getElementById("confidenceIcon");
        const text = document.getElementById("confidenceText");

        bar.className = "confidence-bar";

        if (level === "high") {
            bar.classList.add("confidence-high");
            icon.textContent = "‚úÖ";
            text.textContent = "High confidence ‚Äî please double-check the fields below";
        } else if (level === "medium") {
            bar.classList.add("confidence-medium");
            icon.textContent = "‚ö†Ô∏è";
            text.textContent = "Medium confidence ‚Äî some fields may need correction";
        } else {
            bar.classList.add("confidence-low");
            icon.textContent = "üîç";
            text.textContent = "Low confidence ‚Äî please carefully review all fields";
        }
    }

    // ================================================================
    // STEP 3:  Submit voter and go back to scan (or finish)
    // ================================================================
    async function submitVoter() {
        // Validate required fields
        const firstName = document.getElementById("vFirstName").value.trim();
        const lastName = document.getElementById("vLastName").value.trim();
        const street = document.getElementById("vStreet").value.trim();
        const city = document.getElementById("vCity").value.trim();
        const zip = document.getElementById("vZip").value.trim();

        if (!firstName || !lastName || !street || !city || !zip) {
            showError("reviewError", "Please fill in all required fields.");
            return false;
        }

        // Validate state-specific DOB
        if (selectedState === "Georgia" || selectedState === "Colorado") {
            const yob = document.getElementById("vYOB").value.trim();
            if (!yob || !/^\d{4}$/.test(yob)) {
                showError("reviewError", "Please enter a valid 4-digit year of birth.");
                return false;
            }
        } else if (selectedState !== "North Carolina") {
            const dobMonth = document.getElementById("vDOBMonth").value;
            const dobDay = document.getElementById("vDOBDay").value;
            const dobYear = document.getElementById("vDOBYear").value;
            if (!dobMonth || !dobDay || !dobYear) {
                showError("reviewError", "Please select the full date of birth.");
                return false;
            }
        }

        hideError("reviewError");

        // Build voter data
        const voterData = {
            firstName: firstName,
            middleName: document.getElementById("vMiddleName").value.trim(),
            lastName: lastName,
            suffix: document.getElementById("vSuffix").value.trim(),
            street: street,
            apt: document.getElementById("vApt").value.trim(),
            city: city,
            state: selectedState,
            zip: zip,
            dob: "",
            gaYOB: ""
        };

        if (selectedState === "Georgia" || selectedState === "Colorado") {
            voterData.gaYOB = document.getElementById("vYOB").value.trim();
        } else if (selectedState !== "North Carolina") {
            const m = document.getElementById("vDOBMonth").value;
            const d = document.getElementById("vDOBDay").value;
            const y = document.getElementById("vDOBYear").value;
            if (m && d && y) {
                voterData.dob = `${m}/${d}/${y}`;
            }
        }

        // Build drive info
        const driveInfo = {
            leaderFirst: document.getElementById("leaderFirst").value.trim(),
            leaderLast: document.getElementById("leaderLast").value.trim(),
            driveDate: document.getElementById("driveDate").value,
            driveTime: document.getElementById("driveTime").value,
            city: document.getElementById("driveCity").value.trim(),
            state: selectedState
        };

        // Disable buttons
        document.getElementById("submitVoterBtn").disabled = true;

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                redirect: "follow",
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify({
                    action: "submit",
                    driveInfo: driveInfo,
                    voters: [voterData]
                })
            });

            const text = await response.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch (parseErr) {
                throw new Error("Unexpected response from server.");
            }

            if (result.error) {
                throw new Error(result.error);
            }

            voterCount++;
            document.getElementById("voterCountNum").textContent = voterCount;
            return true;

        } catch (err) {
            showError("reviewError", "Submission failed: " + err.message);
            return false;

        } finally {
            document.getElementById("submitVoterBtn").disabled = false;
        }
    }

    async function submitVoterAndNext() {
        const success = await submitVoter();
        if (success) {
            resetScanStep();
            document.getElementById("step3").classList.add("hidden");
            document.getElementById("step2").classList.remove("hidden");
            window.scrollTo({ top: 0, behavior: "smooth" });
        }
    }

    async function submitVoterAndFinish() {
        const success = await submitVoter();
        if (success) {
            showCompletionScreen();
        }
    }

    function finishDrive() {
        if (voterCount === 0) {
            if (!confirm("You haven't submitted any voters yet. Are you sure you want to finish?")) return;
        }
        showCompletionScreen();
    }

    function showCompletionScreen() {
        document.getElementById("step2").classList.add("hidden");
        document.getElementById("step3").classList.add("hidden");
        document.getElementById("step4").classList.remove("hidden");
        document.getElementById("finalCount").textContent = voterCount;
        document.getElementById("finalPlural").textContent = voterCount === 1 ? "" : "s";
        document.getElementById("finalCount2").textContent = voterCount;
        document.getElementById("finalPlural2").textContent = voterCount === 1 ? "" : "s";
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ================================================================
    // RESET & UTILITIES
    // ================================================================
    // Go back to scan step to re-scan the same form
    function rescanForm() {
        resetScanStep();
        document.getElementById("step3").classList.add("hidden");
        document.getElementById("step2").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function resetScanStep() {
        document.getElementById("scanFile").value = "";
        document.getElementById("scanArea").style.display = "block";
        document.getElementById("processingOverlay").classList.remove("active");
        hideError("scanError");

        // Clear review form
        document.getElementById("vFirstName").value = "";
        document.getElementById("vMiddleName").value = "";
        document.getElementById("vLastName").value = "";
        document.getElementById("vSuffix").value = "";
        document.getElementById("vStreet").value = "";
        document.getElementById("vApt").value = "";
        document.getElementById("vCity").value = "";
        document.getElementById("vZip").value = "";
        document.getElementById("vDOBMonth").value = "";
        document.getElementById("vDOBDay").value = "";
        document.getElementById("vDOBYear").value = "";
        document.getElementById("vYOB").value = "";
        hideError("reviewError");
    }

    function startNewDrive() {
        // Full reset
        voterCount = 0;
        selectedState = "";
        resetScanStep();

        document.getElementById("leaderFirst").value = "";
        document.getElementById("leaderLast").value = "";
        document.getElementById("driveCity").value = "";
        document.getElementById("driveState").value = "";

        // Reset date/time to now
        const today = new Date();
        document.getElementById("driveDate").value = today.toISOString().split("T")[0];
        const hh = String(today.getHours()).padStart(2, "0");
        const mm = String(today.getMinutes()).padStart(2, "0");
        document.getElementById("driveTime").value = `${hh}:${mm}`;

        document.getElementById("voterCountNum").textContent = "0";

        document.getElementById("step4").classList.add("hidden");
        document.getElementById("step1").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ---- Error handling ----
    function showError(id, msg) {
        const el = document.getElementById(id);
        el.textContent = msg;
        el.className = "status error";
    }
    function hideError(id) {
        const el = document.getElementById(id);
        el.style.display = "none";
        el.className = "status";
        el.textContent = "";
        // Re-enable display:none via class removal
        setTimeout(() => { el.style.display = ""; }, 10);
    }

    // ---- Formatting helpers ----
    function formatDate(dateStr) {
        const [y, m, d] = dateStr.split("-");
        return `${parseInt(m)}/${parseInt(d)}/${y}`;
    }
    function formatTime(timeStr) {
        let [h, m] = timeStr.split(":");
        h = parseInt(h);
        const ampm = h >= 12 ? "PM" : "AM";
        if (h > 12) h -= 12;
        if (h === 0) h = 12;
        return `${h}:${m} ${ampm}`;
    }
    // ---- FAQ toggle ----
    function toggleFAQ() {
        const faqContainer = document.getElementById('faqContainer');
        if (faqContainer) {
            faqContainer.classList.toggle('show');
            if (faqContainer.classList.contains('show')) {
                setTimeout(() => {
                    faqContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }
    }
</script>

</body>
</html>
